name: CI / Canary CD

on:
  push:
      branches: [jinyoung]

jobs:
  ci-cd:
      runs-on: ubuntu-latest

      env:
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        IMAGE_NAME: goormthon
        IMAGE_TAG: ${{ github.sha }}
        REGION: us-central1
        SERVICE_NAME: goormthon

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up JDK
          uses: actions/setup-java@v4
          with:
            java-version: 21
            distribution: 'adopt'

        - name: GCP 인증
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ secrets.GCP_SA_KEY }}

        - name: Docker 인증 구성
          run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

        - name: Gradle 권한 설정
          run: chmod +x gradlew

        - name: Build with Gradle (Test 제외)
          run: ./gradlew build --exclude-task test

        - name: Docker 이미지 빌드 및 푸시
          run: |
            docker build \
              -t us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/docker/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
            docker push us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/docker/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

        - name: Cloud Run 새 리비전 배포 (canary)
          run: |
            gcloud run deploy $SERVICE_NAME \
              --image us-central1-docker.pkg.dev/$GCP_PROJECT_ID/docker/$IMAGE_NAME:$IMAGE_TAG \
              --region $REGION \
              --platform managed \
              --no-traffic \
              --allow-unauthenticated

        - name: Canary 트래픽 10%로 분할
          run: |
            EXISTING_REVISION=$(gcloud run services describe $SERVICE_NAME \
            --region $REGION \
            --format="value(status.traffic[0].revisionName)")
            
            NEW_REVISION=$(gcloud run services describe $SERVICE_NAME \
            --region $REGION \
            --format="value(status.latestReadyRevisionName)")
            
            gcloud run services update-traffic $SERVICE_NAME \
            --region $REGION \
            --to-revisions=$NEW_REVISION=10,$EXISTING_REVISION=90

        - name: Cloud Run 권한 확인 및 부여 (allUsers 공개 접근)
          run: |
            gcloud run services add-iam-policy-binding $SERVICE_NAME \
              --region $REGION \
              --to-revisions $NEW_REVISION=10,$EXISTING_REVISION=90
              --member="allUsers" \
              --role="roles/run.invoker" || true
